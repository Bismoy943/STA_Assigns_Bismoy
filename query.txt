select CONCAT(EBBS_ACCOUNT.CURRENCYCODE,'-',TRIM(EBBS_ACCOUNT.ACCOUNTNO)) as ACCT_ID, EBBS_ACCOUNT.CURRENCYCODE as ACCT_CCY, CONCAT(EBBS_ACCOUNT.CURRENCYCODE,TRIM(EBBS_ACCOUNT.ACCOUNTNO)) as ACCT_REF_ID, EBBS_ACCOUNT.COUNTRY as CTRY_CD, '9999-12-31' as END_DT, EBBS_ACCOUNT.ods as STRT_DT, 'EBBS' as SRC_SYS, 'Account' as ACCT_CAT_CD, EBBS_ACCOUNT.ACCLOSEDT as ACCT_CLSE_DT, EBBS_ACCOUNT.ACCLOSUREREASON as ACCT_CLSR_RSN, EBBS_ACCOUNT.CRINTINDFLAG as ACCT_CR_INT_ACR_FLG, EBBS_ACCOUNT.DRINTINDFLAG as ACCT_DR_INT_ACRL_FLG, EBBS_ACCOUNT.TRANSTODORMANTDATE as ACCT_DRMT_DT, NULL as ACCT_FRZN_CD, NULL as ACCT_IN_COL_FLG, 'F' as ACCT_INT_TYPE_CD, EBBS_ACCOUNT.CRINTCURRENCYCODE as ACCT_INT_ACC_CCY, NULL as ACCT_LAST_CR_TRAN_AMT, NULL as ACCT_LAST_DR_TRAN_AMT, EBBS_EXCRTL.EXCESSSHRTAMT as ACCT_LAST_EXCES_TRAN_AMT, EBBS_ACCOUNT.ACOPENDATE as ACCT_OPEN_DT, EBBS_ACCOUNT.ACCOUNTBRANCH as ACCT_OPEN_BR_CD, CASE WHEN EBBS_INTPL.REFNO <> 'NULL' then 'P' when EBBS_INTPLDT.REFNO<> 'NULL' then 'C' ELSE '' end as ACCT_POOL_FLG, COALESCE(EBBS_INTPLDT.REFNO, EBBS_INTPL.REFNO,'') as ACCT_POOL_ID, NULL as ACCT_PREV_CR_TRAN_DT, EBBS_ACCOUNT.LASTDRTRNDATE as ACCT_PREV_DR_TRAN_DT, EBBS_ACCOUNT.ACREOPENDT as ACCT_REACTIVATED_DT, EBBS_ACCOUNT.SHORTNAME as ACCT_SHORT_NM, EBBS_ACCOUNT.ACCTITLE2 as ACCT_STMT_ADD_TITL, EBBS_ACCOUNT.ACCTCURRENTSTATUS as ACCT_STS_CD, EBBS_ACCOUNT.TRANSTOUNCLAIMDATE as ACCT_UNCLAIM_DT, EBBS_ACCOUNT.CRLASTACCADJAMOUNT as ACR_INT_ADJ_AMT, NULL as AMORT_FLG, NULL as AMORT_TYPE, NULL as ANCHOR_ID, NULL as ANCHOR_NM, EBBS_ACCOUNT.CHECKERDATE as AUTH_DT, NULL as BASE_TENR, NULL as BNF_CUST_NM, G.COMP_CD as BK_CD, EBBS_ACCOUNT.COUNTRY as BKG_CTRY_CD, scbentityxlate.sci_entity_code as BKG_LOC_CD, NULL as CAP_RELIEF, trim(cast(EBBS_ACCOUNT.MASTERNO as varchar(128))) as CP_ID, EBBS_INTCURR.CRINTCHARGEBASIS as CR_INT_ACR_BSIS_CD, EBBS_ACCOUNT.CRLASTACCADJAMOUNT as CR_INT_ADJ_ACR_AMT, EBBS_ACCOUNT.CRINTACCRUEDAMT as CR_INT_LAST_ACR_AMT, EBBS_ACINTHIS_C.INTPAIDDATE as CR_INT_LAST_PYMT_DT, CASE WHEN EBBS_ACINTHIS_C.CREDITDEBIT = 'C' THEN EBBS_ACINTHIS_C.TOTAL_INT_PD END as CR_INT_LAST_PYMT_AMT, EBBS_INTCURR.CRINTPAYFREQ as CR_INT_PYMT_FREQ, EBBS_ACCOUNT.CRINTPRODUCTCODE as CR_INT_PRD_CD, NULL as CR_PROT_OS_FIN_AMT, NULL as CROSS_CCY_DEAL_FLG, NULL as CURR_INT_COL_OPT, NULL as CURR_INT_PYMT_FRQ, NULL as CURV_FLG, EBBS_ACCOUNT.INTINSUSPENSE as CUST_ACCT_INT_IN_SUSP_FLG, NULL as CUST_DEP_TYPE_CD, NULL as CUST_DEP_VAL_DT, NULL as CUST_INT_BASE_RT, NULL as CUST_MRGN_RT, NULL as CUST_MRGN_RT_FLG, NULL as NXT_MATURITY_DT, CONCAT('EBBS','-',EBBS_ACCOUNT.COUNTRY) as DATA_SRC, NULL as DAY_CNT_CONV_CD, CASE WHEN TRIM(EBBS_LMTLNDT.LIMITNO) IS NULL THEN datediff(to_date(EBBS_EXCRTL.ODS), to_date(EBBS_EXCRTL.LASTEXCESSUPDATEDDATE)) WHEN CONCAT(trim(EBBS_LMTLNDT.MASTERNO), '-', TRIM(EBBS_LMTLNDT.LIMITNO)) IS NOT NULL AND EBBS_LMTLNDT.EXCESSSTARTDATE IS NOT NULL THEN datediff(to_date(EBBS_LMTLNDT.ODS), to_date(EBBS_LMTLNDT.EXCESSSTARTDATE)) WHEN CONCAT(trim(EBBS_LMTLNDT.MASTERNO), '-', TRIM(EBBS_LMTLNDT.LIMITNO)) IS NOT NULL AND EBBS_LMTLNDT.EXCESSSTARTDATE IS NULL THEN datediff(to_date(EBBS_LMTLNDT.ODS), to_date(EBBS_EXCRTL.LASTEXCESSUPDATEDDATE)) END as DAYS_PAST_DUE, NULL as DEAL_CLSE_DSR_ID, NULL as DEAL_LIEN_AMT, NULL as DEAL_MATCH_FLG, NULL as DEAL_REPR_STRT_DT, NULL as DEAL_ROLL_OVER_CNT, NULL as DEAL_SRC_DSR_ID, NULL as DEAL_TERM_AMT, NULL as DEAL_TERM_TYPE, NULL as DEAL_TRSRY_RT, EBBS_INTCURR.DRINTCHARGEBASIS as DR_INT_ACR_BSIS_CD, EBBS_INTCURR.DRBANDPROGREG as DR_INT_BAND_METH, EBBS_ACCOUNT.DRINTACCRUEDAMT as DR_INT_LAST_ACR_AMT, EBBS_ACCOUNT.CRNEXTINTPAYDATE as CR_INT_NXT_PYMT_DT, EBBS_ACINTHIS_D.INTPAIDDATE as DR_INT_LAST_PYMT_DT, NULL as DR_INT_PYMT_FREQ, NULL as DR_INT_ADJ_ACR_AMT, EBBS_ACCOUNT.DRINTPRODUCTCODE as DR_INT_PRD_CD, NULL as DISAPPROVED_PERIOD, CASE WHEN EBBS_ACCINFO_FOL.informationcode = 'FOL' then EBBS_ACCINFO_FOL.INFODETCODE ELSE '' end as FAC_ORIG_LOC, 'Account' as FILE_TYPE, EBBS_ACCOUNT.ACOPENDATE as FST_LN_DRWDOWN_DT, NULL as FIX_PERIOD, NULL as FRT_ON_LAND_CD, NULL as FTP_BASE_RT, NULL as FTP_BE_LIQ_PRIM_RT, NULL as FTP_CONTR_LIQ_PRIM_RT, NULL as FTP_COST_OF_LIQ_RT, NULL as FTP_CTRY_COST_OF_LIQ_RT, NULL as FTP_INCT_PRIM_RT, NULL as FTP_LIQ_PRIM_RT_DT, NULL as FTP_LIQ_PRIM_TENR, NULL as FTP_RT_DT, NULL as FUND_PL_MATURITY_DT, EBBS_ACCOUNT.TRANPRICINGRATE as FTP_RT, NULL as INT_ACR_UP_TO_DT, NULL as INT_ACR_AMT, NULL as INT_BAND_BRKP, NULL as INT_BASE_RT_MULT, NULL as INT_BASE_RT_TYPE, NULL as INT_CALC_DAY_CONV, NULL as INT_ONLY_FLG, NULL as INT_PYMT_DAY_CONV, NULL as INT_PYMT_DUE_DT, (coalesce(EBBS_INTDTL.CRINTRATE,0)-coalesce(EBBS_INTDTL.DRINTRATE,0)-coalesce(EBBS_INTDTL.EXCESSINTRATE,0)) as INT_RT, EBBS_INTCURR.EFFECTIVEDATE as INT_RT_EFF_DT, 'Fixed' as INT_RT_TYPE, NULL as INT_REPYMT_FREQ, NULL as INT_PYMT_STRT_DT, NULL as ISLM_ACCT_FLG, NULL as ISLM_SUB_PRD, EBBS_ACCOUNT.LASTCRINTRATE as LAST_CR_INT_RT, EBBS_ACCOUNT.LASTCRTRNEXCLSYSDT as LAST_CUST_INIT_CR_TRAN_DT, EBBS_ACCOUNT.LASTDRTRNEXCLSYSDT as LAST_CUST_INIT_DR_TRAN_DT, EBBS_ACCOUNT.LASTDRINTRATE as LAST_DR_INT_RT, EBBS_EXCRTL.EXCESSSHRTAMT as LAST_EXCES_AMT, EBBS_EXCRTL.LASTEXCESSUPDATEDDATE as LAST_EXCES_DT, NULL as LAST_INT_PYMT_DT, NULL as LAST_INT_REPR_DT, scbentityxlate.sci_entity_code as LGL_ENT_CD, scbentityxlate.sci_bkg_loctn_id as LGL_ENT_ID, NULL as LIBR_DIBR_FLG, EBBS_ACCOUNT.ACCTCURRENTSTATUS as LIFCYCL_STS_CD, EBBS_ACCOUNT.ACCLASSCODE as LN_CLAS, EBBS_ACCOUNT.ACOPENDATE as LN_EFF_DT, NULL as LN_TENR_IN_DAYS, EBBS_ACCOUNT.PRODUCTCODE as LOCAL_PRD_CD, NULL as LOCAL_PRD_CD_CHG_DT, EBBS_ACCOUNT.MATURITYDATE as MATURITY_DT, NULL as MATURITY_INT_AMT, NULL as MAX_TENR, NULL as NXT_INT_PYMT_DT, NULL as NXT_INT_REPR_DT, NULL as NXT_PYMT_DT, CASE WHEN EBBS_ACCINFO_NOSTRO.informationcode = 'TLM' then 'Y' ELSE '' end as NOST_SUSP_FLG, NULL as OBL_FLG, NULL as ORIG_MATURTY_DT, NULL as ORIG_TERM_TYPE, NULL as ORIG_PRIN_AMT, EBBS_MLTMAST.LMTPRVPRDCD as OVR_DFT_TYPE, EBBS_PRVINFO.IMPAIRMENT as PAST_DUE_FLG, NULL as PAST_DUE_INT_COL_OPT, NULL as PAST_DUE_INT_PYMT_FREQ, NULL as PNLTY_AMT, NULL as PNLTY_CHRG_FLG, NULL as PRE_PYMT_RT, NULL as PREV_LOCAL_PRD_CD, NULL as PRIN_PYMT_FREQ, NULL as PRG_CD, EBBS_PRVINFO.PRVPRDCD as PRVSN_PRD_CD, NULL as PRPS_CD, NULL as REPR_DT, NULL as RECRSE_FLG, NULL as REG_INT_COL_OPT, NULL as RISK_PRTY_ID, NULL as ROLL_OVER_FLG, NULL as ROLL_OVER_INT_CAP_FLG, NULL as RLOVR_ORIG_INT_RT_FLG, NULL as SCTY_TYPE_CD, NULL as SEL_DOWN_FLG, NULL as SETLM_DT, trim(cast(EBBS_MASTREL.RELATIONSHIPNO as varchar(128))) as SRC_CUST_ID, m_product_xlate.basel_prod_code as STD_PRD_CD, NULL as STRUC_NM, NULL as STRUC_TRD_FLG, NULL as STRUC_TRD_SUB_TYPE, NULL as STRUC_TRD_TYPE, NULL as SUST_TRD_FIN_FLG, EBBS_PRVINFO.TOTALCHARGEOFFAMT as TOT_CHRG_OFF_AMT, NULL as TP_ENT_NM, NULL as ULT_RISK_CTRY, EBBS_ACCOUNT.TRANSTOUNCLAIMDATE as UNCLAIM_DT, NULL as UWRT_TYPE, CASE WHEN EBBS_ACCINFO_VOSTRO.informationcode = 'TM3' then 'Y' ELSE '' end as VOST_FLG, NULL as WAIVE_EXCES_INT_FLG, NULL as INT_RT_BSIS_CD, NULL as NON_CR_PROT_OS_FIN_AMT, NULL as INT_PYMT_FREQ, NULL as TRD_FIN_TYPE, NULL as TRUE_SALES_FLG, EBBS_BRN.NAME as ACCT_BR_NM, NULL as ACTG_METH_CD, NULL as FST_INT_PYMT_DT, NULL as FST_PRIN_PYMT_DT, EBBS_PRVINFO.IISDATE as INT_PAST_DUE_DT, EBBS_ACCOUNT.CURRENCYCODE as LOCAL_CCY, NULL as LOCAL_CCY_FX_RT, NULL as PRIN_PAST_DUE_DT, NULL as PTFOL_ID, NULL as PTFOL_NM, NULL as RESV_RT, NULL as RMNG_TENR, NULL as LPC_GRP_CD, NULL as LPC_TYPE, NULL as OS_INVC_DT, NULL as TP_BIZ_GRP_CD, EBBS_ACCOUNT.SEGMENTCODE as TP_BIZ_SGMT_CD, NULL as TP_BIZ_SUB_SGMT_CD, NULL as TP_BIZ_UNIT_CD, NULL as ACCT_STS_DESC, NULL as FAC_ORIG_LOC_DESC, NULL as INT_PYMT_FREQ_DESC, NULL as INT_RT_TYPE_DESC, NULL as LN_CLAS_DESC, EBBS_PRD.DESCRIPTION as LOCAL_PRD_DESC, NULL as PRIN_PYMT_FREQ_DESC, NULL as PRPS_DESC, NULL as LPC_GRP_DESC, NULL as LPC_TYPE_DESC, NULL as REPRC_FREQ, NULL as REPRC_FREQ_DESC, NULL as STRUC_TYPE, NULL as STRUC_TYPE_DESC, NULL as RLOVR_WAIT_PERIOD, NULL as TRNCH_ID, NULL as CARD_BLK_CD, NULL as CASH_ADVN_INT_RT, NULL as CR_CARD_TYPE_CD, NULL as AVAIL_CR_AMT, NULL as CR_CARD_USR_CD, NULL as ACCT_STM_CYC_DAY, EBBS_ACCOUNT.CHECKERDATE as ACCT_LAST_MOD_DT, NULL as ACCT_LAST_MOD_TM, EBBS_SEG.CORPORATEFLAG as ACCT_CORP_FLG, EBBS_SEG.BFSFLAG as ACCT_SME_FLG, EBBS_ACCOUNT.crintadjamt as CR_INT_ADJ_AMT, EBBS_ACCOUNT.drintadjamt as DR_INT_ADJ_AMT, EBBS_ACCOUNT.crmanualadjamt as CR_INT_MAN_ADJ_AMT, EBBS_ACCOUNT.drmanualadjamt as DR_INT_MAN_ADJ_AMT, EBBS_ACCOUNT.ATMFLAG as ATM_FLG, NULL as prd_cd_desc, NULL as SPL_PRD_FLG, EBBS_REASON.DESCRIPTION as ACCT_CLSR_RSN_DESC, CASE WHEN EBBS_ACINTHIS_D.CREDITDEBIT = 'D' THEN EBBS_ACINTHIS_D.TOTAL_INT_PD END as DR_INT_LAST_PYMT_AMT, EBBS_ACCOUNT.DRNEXTINTPAYDATE as DR_INT_NXT_PYMT_DT, NULL as DR_INT_NXT_PYMT_AMT, NULL as CR_INT_NXT_PYMT_AMT, coalesce(EBBS_INTDTL.EXCESSINTRATE,0) as EXCES_DR_INT_RT, COALESCE(CONCAT(cast(M_SCI_XREF_XLATE.LSX_LE_ID AS varchar(128)),'-',cast(M_SCI_XREF_XLATE.LSX_LSP_ID AS varchar(128))),ALT_PRTY.ALT_PRTY_ID,ALT_PRTY1.ALT_PRTY_ID) as PRTY_ID, CASE WHEN EBBS_ACCOUNT.ACCTCURRENTSTATUS ='O' THEN EBBS_ACCOUNT.ACOPENDATE WHEN EBBS_ACCOUNT.ACCTCURRENTSTATUS = 'D' THEN EBBS_ACCOUNT.TRANSTODORMANTDATE WHEN EBBS_ACCOUNT.ACCTCURRENTSTATUS = 'U' THEN EBBS_ACCOUNT.TRANSTOUNCLAIMDATE WHEN EBBS_ACCOUNT.ACCTCURRENTSTATUS = 'C' THEN EBBS_ACCOUNT.ACCLOSEDT WHEN EBBS_ACCOUNT.ACCTCURRENTSTATUS = 'A' AND (EBBS_ACCOUNT.ACREOPENDT IS NOT NULL AND EBBS_ACCOUNT.reactivedate IS NOT NULL) AND EBBS_ACCOUNT.ACREOPENDT > EBBS_ACCOUNT.reactivedate THEN EBBS_ACCOUNT.ACREOPENDT WHEN EBBS_ACCOUNT.ACCTCURRENTSTATUS = 'A' AND (EBBS_ACCOUNT.ACREOPENDT IS NOT NULL AND EBBS_ACCOUNT.reactivedate IS NOT NULL) AND EBBS_ACCOUNT.ACREOPENDT < EBBS_ACCOUNT.reactivedate THEN EBBS_ACCOUNT.reactivedate WHEN EBBS_ACCOUNT.ACCTCURRENTSTATUS = 'A' AND EBBS_ACCOUNT.ACREOPENDT IS NULL AND EBBS_ACCOUNT.reactivedate IS NULL THEN EBBS_ACCOUNT.ACOPENDATE WHEN EBBS_ACCOUNT.ACCTCURRENTSTATUS = 'A' AND EBBS_ACCOUNT.ACREOPENDT IS NULL AND EBBS_ACCOUNT.reactivedate IS NOT NULL THEN EBBS_ACCOUNT.reactivedate WHEN EBBS_ACCOUNT.ACCTCURRENTSTATUS = 'A' AND EBBS_ACCOUNT.ACREOPENDT IS NOT NULL AND EBBS_ACCOUNT.reactivedate IS NULL THEN EBBS_ACCOUNT.ACREOPENDT ELSE NULL END as LIFCYCL_STS_DT, NULL as CR_PRVSN_ACCT_ID, NULL as DR_PRVSN_ACCT_ID, ebbs_accountmisc.transactorflag as TRANSCTR_FLG, EBBS_ACCOUNT.ODS as ODS from fdp_ebbs_all_sri_open_dev3.EBBS_ACCOUNT left outer join fdp_ebbs_all_sri_open_dev3.EBBS_EXCRTL EBBS_EXCRTL on EBBS_EXCRTL.CURRENCYCODE = EBBS_ACCOUNT.CURRENCYCODE and TRIM(EBBS_EXCRTL.ACCOUNTNO) = TRIM(EBBS_ACCOUNT.ACCOUNTNO) AND EBBS_EXCRTL.COUNTRY = EBBS_ACCOUNT.COUNTRY AND EBBS_EXCRTL.ods='2024-09-30' AND EBBS_EXCRTL.COUNTRY='ZA' left outer join (SELECT LEADERCURRENCYCODE,LEADERACCOUNTNO,ods,country,REFNO, ROW_NUMBER() OVER (PARTITION BY LEADERCURRENCYCODE,LEADERACCOUNTNO,ods,country ORDER BY poolchangeddate desc) AS ROW_NUM FROM fdp_ebbs_all_sri_open_dev3.EBBS_INTPL WHERE ODS='2024-09-30')EBBS_INTPL on EBBS_INTPL.LEADERCURRENCYCODE = EBBS_ACCOUNT.CURRENCYCODE and TRIM(EBBS_INTPL.LEADERACCOUNTNO) = TRIM(EBBS_ACCOUNT.ACCOUNTNO) AND EBBS_INTPL.ODS=EBBS_ACCOUNT.ODS AND EBBS_INTPL.COUNTRY=EBBS_ACCOUNT.COUNTRY AND EBBS_INTPL.ods='2024-09-30' AND EBBS_INTPL.COUNTRY='ZA' AND EBBS_INTPL.ROW_NUM=1 left outer join (SELECT CURRENCYCODE,ACCOUNTNO,ods,country,REFNO,s_startdt, ROW_NUMBER() OVER (PARTITION BY COUNTRY,CURRENCYCODE,ACCOUNTNO,ods ORDER BY s_startdt desc) AS ROW_NUM FROM fdp_ebbs_all_sri_open_dev3.EBBS_INTPLDT WHERE ODS='2024-09-30')EBBS_INTPLDT on EBBS_INTPLDT.CURRENCYCODE = EBBS_ACCOUNT.CURRENCYCODE and TRIM(EBBS_INTPLDT.ACCOUNTNO) = TRIM(EBBS_ACCOUNT.ACCOUNTNO) AND EBBS_INTPLDT.ODS=EBBS_ACCOUNT.ODS AND EBBS_INTPLDT.COUNTRY=EBBS_ACCOUNT.COUNTRY AND EBBS_INTPLDT.ods='2024-09-30' AND EBBS_INTPLDT.COUNTRY='ZA' AND EBBS_INTPLDT.ROW_NUM=1 left outer join (SELECT a.CRINTCHARGEBASIS, a.CRINTPAYFREQ, a.DRINTCHARGEBASIS, a.DRBANDPROGREG, a.interestcode, a.CURRENCYCODE, a.EFFECTIVEDATE, a.ODS, a.country FROM (SELECT CRINTCHARGEBASIS, CRINTPAYFREQ, DRINTCHARGEBASIS, DRBANDPROGREG, interestcode, CURRENCYCODE, EFFECTIVEDATE, ODS, country FROM fdp_ebbs_all_sri_open_dev3.EBBS_INTCURR where ODS='2024-09-30') a JOIN (SELECT max(EFFECTIVEDATE) AS EFFECTIVEDATE, interestcode, CURRENCYCODE,country FROM fdp_ebbs_all_sri_open_dev3.EBBS_INTCURR where ODS='2024-09-30' GROUP BY interestcode,CURRENCYCODE, country) b ON a.EFFECTIVEDATE=b.EFFECTIVEDATE AND a.interestcode=b.interestcode AND a.country=b.country AND a.CURRENCYCODE=b.CURRENCYCODE) EBBS_INTCURR on EBBS_INTCURR.CURRENCYCODE = EBBS_ACCOUNT.CURRENCYCODE AND EBBS_INTCURR.INTERESTCODE = EBBS_ACCOUNT.INTERESTCODE AND EBBS_INTCURR.COUNTRY = EBBS_ACCOUNT.COUNTRY AND EBBS_INTCURR.ODS=EBBS_ACCOUNT.ODS AND EBBS_INTCURR.ODS='2024-09-30' AND EBBS_INTCURR.COUNTRY='ZA' left outer join fdp_ebbs_all_sri_open_dev3.EBBS_PRVINFO EBBS_PRVINFO on EBBS_PRVINFO.CURRENCYCODE = EBBS_ACCOUNT.CURRENCYCODE and TRIM(EBBS_PRVINFO.REFERENCENO) = TRIM(EBBS_ACCOUNT.ACCOUNTNO) and EBBS_PRVINFO.ODS = EBBS_ACCOUNT.ODS AND EBBS_PRVINFO.COUNTRY = EBBS_ACCOUNT.COUNTRY AND EBBS_PRVINFO.ods='2024-09-30' AND EBBS_PRVINFO.COUNTRY='ZA' left outer join fdp_ebbs_all_sri_open_dev3.EBBS_INTDTL EBBS_INTDTL on EBBS_INTDTL.CURRENCYCODE = EBBS_ACCOUNT.CURRENCYCODE and TRIM(EBBS_INTDTL.ACCOUNTNO) = TRIM(EBBS_ACCOUNT.ACCOUNTNO) and EBBS_INTDTL.accrualdate = '2024-09-30' AND EBBS_INTDTL.COUNTRY = EBBS_ACCOUNT.COUNTRY AND EBBS_INTDTL.ods='2024-09-30' AND EBBS_INTDTL.COUNTRY='ZA' left outer join (SELECT a.CURRENCYCODE, a.ACCOUNTNO, a.SEQNO, a.INFODETCODE, a.informationcode, a.ODS, a.country FROM (SELECT CURRENCYCODE, ACCOUNTNO, SEQNO, INFODETCODE, informationcode, ODS,country FROM fdp_ebbs_all_sri_open_dev3.EBBS_ACCINFO WHERE ODS='2024-09-30') a JOIN (SELECT max(SEQNO) AS SEQNO, INFORMATIONCODE, CURRENCYCODE, ACCOUNTNO, country FROM fdp_ebbs_all_sri_open_dev3.EBBS_ACCINFO WHERE INFORMATIONCODE in ('TLM') AND ODS='2024-09-30' GROUP BY INFORMATIONCODE,CURRENCYCODE,ACCOUNTNO,country) b ON a.SEQNO=b.SEQNO AND a.INFORMATIONCODE = b.INFORMATIONCODE AND a.country = b.country AND a.CURRENCYCODE = b.CURRENCYCODE AND a.ACCOUNTNO = b.ACCOUNTNO) EBBS_ACCINFO_NOSTRO on EBBS_ACCINFO_NOSTRO.CURRENCYCODE = EBBS_ACCOUNT.CURRENCYCODE and TRIM(EBBS_ACCINFO_NOSTRO.ACCOUNTNO) = TRIM(EBBS_ACCOUNT.ACCOUNTNO) and EBBS_ACCINFO_NOSTRO.ODS = EBBS_ACCOUNT.ODS AND EBBS_ACCINFO_NOSTRO.COUNTRY = EBBS_ACCOUNT.COUNTRY AND EBBS_ACCINFO_NOSTRO.ods='2024-09-30' AND EBBS_ACCINFO_NOSTRO.COUNTRY='ZA' left outer join fdp_ebbs_all_sri_open_dev3.EBBS_MLTMAST EBBS_MLTMAST on EBBS_MLTMAST.CURRENCYCODE = EBBS_ACCOUNT.CURRENCYCODE and TRIM(EBBS_MLTMAST.ACCOUNTNO) = TRIM(EBBS_ACCOUNT.ACCOUNTNO) AND EBBS_MLTMAST.ODS=EBBS_ACCOUNT.ODS AND EBBS_MLTMAST.COUNTRY=EBBS_ACCOUNT.COUNTRY AND EBBS_MLTMAST.ods='2024-09-30' AND EBBS_MLTMAST.COUNTRY='ZA' left outer join (select ODS,COUNTRY_CODE,SRC_PROD_CODE,BASEL_PROD_CODE,lcl_prod_desc,src_sys_short_name, ROW_NUMBER() OVER ( PARTITION BY COUNTRY_CODE,SRC_PROD_CODE order by SRC_PROD_CODE) AS ROW_NUM from fdp_mfu_staging_dev3.m_product_xlate where ods='2024-09-30' ) m_product_xlate on trim(EBBS_ACCOUNT.PRODUCTCODE) = trim(m_product_xlate.src_prod_code) and trim(m_product_xlate.src_sys_short_name)='EBBS' and trim(m_product_xlate.country_code)=trim(EBBS_ACCOUNT.COUNTRY) and m_product_xlate.ODS='2024-09-30' and m_product_xlate.country_code='ZA' and m_product_xlate.ROW_NUM = 1 left outer join fdp_ebbs_all_sri_open_dev3.EBBS_BRN EBBS_BRN on EBBS_BRN.BRANCHCODE = EBBS_ACCOUNT.ACCOUNTBRANCH AND EBBS_BRN.COUNTRY = EBBS_ACCOUNT.COUNTRY and EBBS_BRN.ODS = EBBS_ACCOUNT.ODS AND EBBS_BRN.ods='2024-09-30' AND EBBS_BRN.COUNTRY='ZA' left outer join (SELECT COUNTRY, ODS, masterno, Relationshipno, primaryflag, ROW_NUMBER() OVER (PARTITION BY Relationshipno ORDER BY Relationshipno ASC,s_startdt DESC) AS ROW_NUM FROM fdp_ebbs_all_sri_open_dev3.EBBS_MASTREL WHERE ods= '2024-09-30' AND PRIMARYFLAG = 'Y' )EBBS_MASTREL on TRIM(EBBS_MASTREL.MASTERNO)=TRIM(EBBS_ACCOUNT.MASTERNO) AND EBBS_MASTREL.ODS = EBBS_ACCOUNT.ODS AND EBBS_MASTREL.ods='2024-09-30' AND EBBS_MASTREL.COUNTRY='ZA' AND EBBS_MASTREL.ROW_NUM =1 left outer join fdp_ebbs_all_sri_open_dev3.EBBS_SEG EBBS_SEG on EBBS_ACCOUNT.SEGMENTCODE = EBBS_SEG.SEGMENTCODE and EBBS_ACCOUNT.ods=EBBS_SEG.ods AND EBBS_ACCOUNT.COUNTRY=EBBS_SEG.COUNTRY AND EBBS_SEG.COUNTRY='ZA' AND EBBS_SEG.ods='2024-09-30' left outer join fdp_ebbs_all_sri_open_dev3.EBBS_PRD EBBS_PRD on EBBS_ACCOUNT.PRODUCTCODE = EBBS_PRD.PRODUCTCODE and EBBS_ACCOUNT.ods=EBBS_PRD.ods AND EBBS_ACCOUNT.COUNTRY=EBBS_PRD.COUNTRY AND EBBS_PRD.ods='2024-09-30' AND EBBS_PRD.COUNTRY='ZA' left outer join (SELECT a.CURRENCYCODE, a.ACCOUNTNO, a.SEQNO, a.INFODETCODE, a.informationcode, a.ODS ,a.country FROM (SELECT CURRENCYCODE, ACCOUNTNO, SEQNO, INFODETCODE, informationcode, country, ODS FROM fdp_ebbs_all_sri_open_dev3.EBBS_ACCINFO WHERE ODS='2024-09-30') a JOIN (SELECT max(SEQNO) AS SEQNO, INFORMATIONCODE, CURRENCYCODE, ACCOUNTNO,country FROM fdp_ebbs_all_sri_open_dev3.EBBS_ACCINFO WHERE INFORMATIONCODE in ('TM3') AND ODS='2024-09-30' GROUP BY INFORMATIONCODE,CURRENCYCODE,ACCOUNTNO,country) b ON a.SEQNO=b.SEQNO AND a.INFORMATIONCODE = b.INFORMATIONCODE AND a.country = b.country AND a.CURRENCYCODE = b.CURRENCYCODE AND a.ACCOUNTNO = b.ACCOUNTNO) EBBS_ACCINFO_VOSTRO on EBBS_ACCINFO_VOSTRO.CURRENCYCODE = EBBS_ACCOUNT.CURRENCYCODE and TRIM(EBBS_ACCINFO_VOSTRO.ACCOUNTNO) = TRIM(EBBS_ACCOUNT.ACCOUNTNO) and EBBS_ACCINFO_VOSTRO.ODS = EBBS_ACCOUNT.ODS AND EBBS_ACCINFO_VOSTRO.COUNTRY = EBBS_ACCOUNT.COUNTRY AND EBBS_ACCINFO_VOSTRO.ods='2024-09-30' AND EBBS_ACCINFO_VOSTRO.COUNTRY='ZA' left outer join (SELECT a.CURRENCYCODE, a.ACCOUNTNO, a.SEQNO, a.INFODETCODE, a.informationcode, a.ODS,a.country FROM (SELECT CURRENCYCODE, ACCOUNTNO, SEQNO, INFODETCODE, informationcode, ODS,country FROM fdp_ebbs_all_sri_open_dev3.EBBS_ACCINFO WHERE ODS='2024-09-30') a JOIN (SELECT max(SEQNO) AS SEQNO, INFORMATIONCODE, CURRENCYCODE, ACCOUNTNO,country FROM fdp_ebbs_all_sri_open_dev3.EBBS_ACCINFO WHERE INFORMATIONCODE in ('FOL') AND ODS='2024-09-30' GROUP BY INFORMATIONCODE,CURRENCYCODE,ACCOUNTNO,country) b ON a.SEQNO=b.SEQNO AND a.INFORMATIONCODE = b.INFORMATIONCODE AND a.country = b.country AND a.CURRENCYCODE = b.CURRENCYCODE AND a.ACCOUNTNO = b.ACCOUNTNO) EBBS_ACCINFO_FOL on EBBS_ACCINFO_FOL.CURRENCYCODE = EBBS_ACCOUNT.CURRENCYCODE and TRIM(EBBS_ACCINFO_FOL.ACCOUNTNO) = TRIM(EBBS_ACCOUNT.ACCOUNTNO) and EBBS_ACCINFO_FOL.ODS = EBBS_ACCOUNT.ODS AND EBBS_ACCINFO_FOL.COUNTRY = EBBS_ACCOUNT.COUNTRY AND EBBS_ACCINFO_FOL.ods='2024-09-30' AND EBBS_ACCINFO_FOL.COUNTRY ='ZA' left outer join fdp_ebbs_all_sri_open_dev3.EBBS_REASON EBBS_REASON on trim(EBBS_ACCOUNT.ACCLOSUREREASON) = trim(EBBS_REASON.reasoncode) and EBBS_ACCOUNT.ods=EBBS_reason.ods AND EBBS_ACCOUNT.COUNTRY=EBBS_reason.COUNTRY AND EBBS_reason.ods='2024-09-30' AND EBBS_reason.COUNTRY='ZA' left outer join (SELECT a.CURRENCYCODE, a.ACCOUNTNO, SUM(a.INTAMTPAID) as TOTAL_INT_PD, a.CREDITDEBIT, a.INTPAIDDATE, a.ODS, a.country FROM (SELECT CURRENCYCODE, ACCOUNTNO, INTAMTPAID, CREDITDEBIT, INTPAIDDATE, ODS,country FROM fdp_ebbs_all_sri_open_dev3.EBBS_ACINTHIS WHERE ODS='2024-09-30') a JOIN (SELECT max(INTPAIDDATE) AS INTPAIDDATE, CURRENCYCODE, ACCOUNTNO, CREDITDEBIT,country FROM fdp_ebbs_all_sri_open_dev3.EBBS_ACINTHIS WHERE ODS='2024-09-30' GROUP BY CURRENCYCODE, ACCOUNTNO, CREDITDEBIT,country) b ON a.INTPAIDDATE=b.INTPAIDDATE AND a.CREDITDEBIT=b.CREDITDEBIT AND a.CURRENCYCODE=b.CURRENCYCODE AND a.country=b.country AND trim(a.accountno) = trim(b.accountno) group by a.CURRENCYCODE,a.ACCOUNTNO, a.CREDITDEBIT,a.INTPAIDDATE,a.ODS,a.country ) EBBS_ACINTHIS_C on EBBS_ACINTHIS_C.CURRENCYCODE = EBBS_ACCOUNT.CURRENCYCODE AND TRIM(EBBS_ACINTHIS_C.ACCOUNTNO) = TRIM(EBBS_ACCOUNT.ACCOUNTNO) and EBBS_ACINTHIS_C.CREDITDEBIT = 'C' AND EBBS_ACINTHIS_C.COUNTRY = EBBS_ACCOUNT.COUNTRY AND EBBS_ACINTHIS_C.ODS='2024-09-30' AND EBBS_ACINTHIS_C.COUNTRY='ZA' left outer join (SELECT a.CURRENCYCODE, a.ACCOUNTNO, SUM(a.INTAMTPAID) as TOTAL_INT_PD, a.CREDITDEBIT, a.INTPAIDDATE, a.ODS, a.country FROM (SELECT CURRENCYCODE, ACCOUNTNO, INTAMTPAID, CREDITDEBIT, INTPAIDDATE, ODS,country FROM fdp_ebbs_all_sri_open_dev3.EBBS_ACINTHIS WHERE ODS='2024-09-30') a JOIN (SELECT max(INTPAIDDATE) AS INTPAIDDATE, CURRENCYCODE, ACCOUNTNO, CREDITDEBIT,country FROM fdp_ebbs_all_sri_open_dev3.EBBS_ACINTHIS WHERE ODS='2024-09-30' GROUP BY CURRENCYCODE, ACCOUNTNO, CREDITDEBIT,country) b ON a.INTPAIDDATE=b.INTPAIDDATE AND a.CREDITDEBIT=b.CREDITDEBIT AND a.CURRENCYCODE=b.CURRENCYCODE AND a.country=b.country AND trim(a.accountno) = trim(b.accountno) group by a.CURRENCYCODE,a.ACCOUNTNO, a.CREDITDEBIT,a.INTPAIDDATE,a.ODS,a.country ) EBBS_ACINTHIS_D on EBBS_ACINTHIS_D.CURRENCYCODE = EBBS_ACCOUNT.CURRENCYCODE AND TRIM(EBBS_ACINTHIS_D.ACCOUNTNO) = TRIM(EBBS_ACCOUNT.ACCOUNTNO) and EBBS_ACINTHIS_D.CREDITDEBIT = 'D' AND EBBS_ACINTHIS_D.ODS=EBBS_ACCOUNT.ODS AND EBBS_ACINTHIS_D.COUNTRY=EBBS_ACCOUNT.COUNTRY AND EBBS_ACINTHIS_D.ODS='2024-09-30' AND EBBS_ACINTHIS_D.COUNTRY='ZA' left outer join (select * from fdp_mfu_staging_dev3.m_scb_entity_xlate where ods='2024-09-30' and tp_system = 'EBBS' ) scbentityxlate on TRIM(EBBS_ACCOUNT.ACCOUNTBRANCH)=scbentityxlate.branch_code AND EBBS_ACCOUNT.COUNTRY=scbentityxlate.country_code AND EBBS_ACCOUNT.ODS=scbentityxlate.ODS and EBBS_ACCOUNT.COUNTRY='ZA' left outer join fdp_mfu_staging_dev3.m_cdl_glbu_to_entcd_bkcd_xlate G on g.GL_BU_CD = trim(EBBS_ACCOUNT.ACCOUNTBRANCH) and G.SRC_SYS='PSGL' and G.CTY='XX' AND G.ods='2024-09-30' left outer join fdp_mfu_staging_dev3.M_SCI_XREF_XLATE on trim(cast(EBBS_ACCOUNT.MASTERNO AS varchar(128)))=M_SCI_XREF_XLATE.LSX_EXT_SYS_CUST_ID AND M_SCI_XREF_XLATE.LSX_EXT_SYS_CODE_VALUE='EBBS' AND M_SCI_XREF_XLATE.ODS='2024-09-30' AND M_SCI_XREF_XLATE.LSX_BKG_LOCTN_ID=scbentityxlate.sci_bkg_loctn_id left outer join fdp_daas_dev3.ALT_PRTY ALT_PRTY on trim(cast(EBBS_ACCOUNT.MASTERNO AS varchar(128)))= ALT_PRTY.PRTY_ID AND ALT_PRTY.process_id_val='ALT_PRTY-SCI-LSPSYSXREF' AND ALT_PRTY.ALT_PRTY_SRC_SYS='EBBS' AND ALT_PRTY.ODS_VAL='2024-09-30' AND ALT_PRTY.TP_SYS_VAL='SCI' AND ALT_PRTY.bkg_org_val=scbentityxlate.sci_entity_code left outer join (SELECT PRTY_ID,ALT_PRTY_ID,bkg_loc,ODS_VAL,TP_SYS_VAL,ALT_PRTY_SRC_SYS, ROW_NUMBER() OVER (PARTITION BY PRTY_ID,BKG_LOC,ODS_VAL ORDER BY EFF_DT) AS ROW_NUM FROM fdp_daas_dev3.ALT_PRTY WHERE ODS_VAL='2024-09-30' and process_id_val='ALT_PRTY-SCI-LSPSYSXREF')ALT_PRTY1 on trim(cast(EBBS_ACCOUNT.MASTERNO AS varchar(128)))= ALT_PRTY1.PRTY_ID AND ALT_PRTY1.ALT_PRTY_SRC_SYS='EBBS' AND ALT_PRTY1.ODS_VAL='2024-09-30' AND ALT_PRTY1.TP_SYS_VAL='SCI' AND ALT_PRTY1.bkg_loc= EBBS_ACCOUNT.COUNTRY AND EBBS_ACCOUNT.COUNTRY='ZA' AND ALT_PRTY1.ROW_NUM=1 left outer join fdp_daas_dev3.PRTY PRTY_SP_SCI on PRTY_SP_SCI.PRTY_ID=ALT_PRTY.ALT_PRTY_ID AND PRTY_SP_SCI.SRC_SYS='SCI' AND PRTY_SP_SCI.PRTY_CAT_CD='SubProfile' AND PRTY_SP_SCI.PROCESS_ID_VAL='PRTY-SCI-SUBPROF' AND PRTY_SP_SCI.ODS_VAL='2024-09-30' left outer join fdp_ebbs_all_sri_open_dev3.ebbs_accountmisc on ebbs_accountmisc.CURRENCYCODE = EBBS_ACCOUNT.CURRENCYCODE AND TRIM(ebbs_accountmisc.ACCOUNTNO) = TRIM(EBBS_ACCOUNT.ACCOUNTNO) AND EBBS_ACCOUNT.COUNTRY=ebbs_accountmisc.COUNTRY AND EBBS_ACCOUNT.ODS='2024-09-30' AND ebbs_accountmisc.ODS='2024-09-30' left outer join fdp_ebbs_all_sri_open_dev3.EBBS_LMTLNDT on CONCAT(trim(EBBS_LMTLNDT.MASTERNO), '-', TRIM(EBBS_LMTLNDT.LIMITNO))=CONCAT(trim(EBBS_ACCOUNT.LIMITMASTERNO), '-', TRIM(EBBS_ACCOUNT.LIMITNO)) AND EBBS_ACCOUNT.COUNTRY=EBBS_LMTLNDT.COUNTRY AND EBBS_LMTLNDT.ods='2024-09-30' AND EBBS_LMTLNDT.COUNTRY='ZA' where EBBS_ACCOUNT.ODS='2024-09-30' and (EBBS_ACCOUNT.STATUSFLAG <> 14 or EBBS_ACCOUNT.ACCLOSEDT> LAST_DAY(CAST(EBBS_ACCOUNT.ODS AS DATE) - INTERVAL '14' MONTH)) AND EBBS_ACCOUNT.COUNTRY='ZA'
